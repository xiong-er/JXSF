# _*_ coding: utf-8 _*_

import numpy as np
import pandas as pd
import streamlit as st
from PIL import Image
import sys
from streamlit import cli as stcli
import streamlit

import csv
import scipy.interpolate as si
import os
import matplotlib.pyplot as plt


#os.environ["KMP_DUPLICATE_LIB_OK"] = "True"
     
# _*_ coding:utf-8 _*_

plt.rcParams['font.sans-serif']=['SimHei'] #æ˜¾ç¤ºä¸­æ–‡

 
def read_allkind_file(filename,title_list):
    #ä¸‡èƒ½æ–‡ä»¶è¯»å–å‡½æ•°v2.0-2023.3.27
    
    # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    if not os.path.exists(filename):
        raise FileNotFoundError(f"File not found: {filename}")
    
    # æ ¹æ®æ–‡ä»¶æ‰©å±•åé€‰æ‹©é€‚å½“çš„è¯»å–å‡½æ•°
    if filename.endswith('.xls') or filename.endswith('.xlsx'):
        df = pd.read_excel(filename)

    elif filename.endswith('.csv'):
        df = pd.read_csv(filename)

    elif filename.endswith('.txt'):
        
        with open(filename,encoding='UTF-8') as f:
            
            reader = csv.reader(f)
            
            for row_num, row in enumerate(reader):
                
                if len(row):
                    row_list = row[0].split('\t')
                if title_list in row_list:
                    break

            else:
            # å¦‚æœæ²¡æœ‰æ‰¾åˆ°å…³é”®è¯è¡Œï¼ŒæŠ›å‡ºå¼‚å¸¸
                raise ValueError("keyword not found in file")
        
        try:
            df = pd.read_csv(filename, encoding='gbk',sep='\t',skiprows=row_num)#gbk
            print('è·³è¿‡å¤´æ–‡ä»¶è¡Œæ•°ï¼š',row_num)
        except:
            df = pd.read_csv(filename, encoding='utf-8',sep='\t',skiprows=row_num)#gbk
            print('è·³è¿‡å¤´æ–‡ä»¶è¡Œæ•°ï¼š',row_num)

    else:
        df = pd.read_table(filename)

    # æ‰“å¼€æ–‡ä»¶å¹¶é€è¡Œè¯»å–ï¼ŒæŸ¥æ‰¾å…³é”®è¯
    
    return df
    

 


def main():

    st.set_page_config(page_icon="ğŸŒ", page_title="æé™é£é€Ÿè®¡ç®—ç¨‹åº", layout="wide")
    
    st.markdown(f'''
        <style>
            .reportview-container .main .block-container {{
            padding-top:0.5rem;
        }}
        </style>
    ''', unsafe_allow_html=True)

    
    image = Image.open('zghz.png')
    st.image(image,  caption=None, width=None, use_column_width=False, clamp=False)

    st.title('æé™é£é€Ÿè®¡ç®—ç¨‹åº')
    tab1 = st.tabs(["1 æé™é£é€Ÿæ¨¡å—"])
    

    csv_filepath=st.text_input("è¾“å…¥æ–‡ä»¶è·¯å¾„,å¦‚ï¼šD:\1é¡¹ç›®\åº·å¹³æœé˜³å ¡é£ç”µåœºâ€œä¸Šå¤§ä¸‹å°â€èµ„æ–™\é£æ•°æ®å¤„ç†_auto\CFT1-Exported.txt")
    title_list=st.text_input('æ•°æ®æ ‡è¯†ç¬¦ï¼Œæµ‹é£æ•°æ®å®é™…å¼€å§‹çš„è¡Œï¼Œé€šå¸¸æœ‰ï¼šDate/Time,Date & Time Stampç­‰')
    #st.info(csv_filepath)
    
    surge_run_switch = st.button('è¯»å–æ•°æ®', key=1)
    st.write("æ•°æ®è¯»å–ï¼šdone!âœ”ï¸ ")

    if surge_run_switch:
        data=read_allkind_file(csv_filepath,title_list)
        st.write(data)
        st.info('å¯ä¾›é€‰æ‹©çš„åˆ—æœ‰ï¼š')
        st.info(list(data.columns))

        
    var=st.text_input("éœ€è¦è®¡ç®—çš„åˆ—ï¼š")
    air_local=st.number_input("å±€åœ°ç©ºæ°”å¯†åº¦ï¼š")
    

    run_switch = st.button('å¼€å§‹è®¡ç®—')
    
    if run_switch:

        #st.write('è§¦å‘')
        data=read_allkind_file(csv_filepath,title_list)
        col = list(data.columns)
        #var = st.selectbox("éœ€è¦è®¡ç®—çš„åˆ—ï¼š",
        #            ("Speed 100 m A [m/s]","11"))

        # æŠŠæ‰€æœ‰åˆ—çš„ç±»å‹éƒ½è½¬åŒ–ä¸ºæ•°å€¼å‹ï¼Œå‡ºé”™çš„åœ°æ–¹å¡«å…¥NaNï¼Œå†æŠŠNaNçš„åœ°æ–¹è¡¥0
        data[var] = data[var].apply(pd.to_numeric, errors='coerce').fillna(0.0)
        # è‡³æ­¤ï¼Œobjectçš„åˆ—ï¼ˆåˆ—ä¸­å­˜å‚¨çš„æ˜¯stringç±»å‹ï¼‰è½¬æˆäº†float
        # æœ€åä¸€æ­¥ï¼ŒæŠŠæ‰€æœ‰åˆ—éƒ½è½¬åŒ–æˆfloatç±»å‹ï¼Œdoneï¼
        df1 = pd.DataFrame(data)#, dtype='float'
        print('æ•°æ®æŠ¬å¤´æŸ¥é˜…ï¼š')
        print(df1)
        ####################æ•°æ®è´¨é‡æ§åˆ¶######################
        print('################æ•°æ®è´¨é‡æ§åˆ¶###################')

        print('æ•°æ®æ—¶é—´åºåˆ—å›¾ï¼š')
        df1[title_list] = pd.to_datetime(df1[title_list]) # dateè½¬ä¸ºæ—¶é—´æ ¼å¼
        fig = plt.figure()#figsize=(30, 10), dpi=200
        plt.plot(df1[title_list],df1[var])#
        plt.xlabel('æ—¥æœŸ')
        plt.ylabel('é£é€Ÿï¼ˆm/sï¼‰')
            #plt.xticks(rotation=90, fontsize=14)
        plt.show()


        #äº”æ—¥é›·æš´æ³•æ±‚æé™é£é€Ÿ
        import numpy as np
        #æ’å€¼æ±‚è€¿è´å°”ç³»æ•°
        df_gumbal=pd.read_excel(r'gumbal.xlsx')
        linear_C1 = si.interp1d(df_gumbal['N'], df_gumbal['C1'], kind="linear")
        linear_C2 = si.interp1d(df_gumbal['N'], df_gumbal['C2'], kind="linear")


        fivedays_max=[]
        for i in range (0,len(df1),720):#720=6ä¸ªæ ·æœ¬ï¼ˆ10min)*24h*5days
            fivedays_max.append(df1.iloc[i:i+721][var].max())
        aver=np.mean(fivedays_max)
        std =np.std(fivedays_max)
        max=np.max(fivedays_max)
        N=len(fivedays_max)
        ####
        st.info('####################################è®¡ç®—ç»“æœ############################################')
        st.write('æ–‡ä»¶:',csv_filepath)
        st.write('å˜é‡ï¼š',var)
        st.write('æ ·æœ¬é‡',N)
        st.write('æœ€å¤§é£é€Ÿï¼š',max)
        st.write('å¹³å‡é£é€Ÿï¼š',df1[var].mean())
        st.write('æ ‡å‡†å·®: ',np.std(df1[var]))
        c1 = linear_C1(N)
        c2 = linear_C2(N)
        #å°ºåº¦å‚æ•°
        aerfa=c1/std
        miu=aver-c2/aerfa
        V50_max=miu-(1/aerfa)*np.log(np.log((50*N)/(50*N-1)))
        st.write('50å¹´ä¸€é‡æœ€å¤§é£é€Ÿï¼š %6.2f'%V50_max,'m/s')
        V50_æå¤§é£é€Ÿ=V50_max*1.4
        st.write('50å¹´ä¸€é‡æå¤§é£é€Ÿï¼š %6.2f'%V50_æå¤§é£é€Ÿ,'m/s')

        #æ ‡å‡†ç©ºæ°”å¯†åº¦ä¸‹æé™é£é€Ÿ
        air_local=1.22
        
    
        
        V50_max_standrd_air=np.sqrt(air_local/1.225)*V50_max
        st.write('æ ‡å‡†ç©ºæ°”å¯†åº¦ä¸‹ï¼Œ50å¹´ä¸€é‡æœ€å¤§é£é€Ÿï¼š %6.2f'%V50_max_standrd_air,'m/s')
        V50_æå¤§_air_standrd_air=V50_max_standrd_air*1.4
        st.write('æ ‡å‡†ç©ºæ°”å¯†åº¦ä¸‹ï¼Œ50å¹´ä¸€é‡æå¤§é£é€Ÿï¼š %6.2f'%V50_æå¤§_air_standrd_air,'m/s')
        st.write("done!ğŸ˜Š")
        #st.image(fig)




if __name__ == '__main__':
    main()
